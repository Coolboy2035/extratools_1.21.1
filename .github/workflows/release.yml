name: Create Release Build

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦è¿™ä¸ªæƒé™æ¥ä¸Šä¼ åˆ°Release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x gradlew

    - name: Extract mod information
      id: mod-info
      run: |
        echo "=== è¯»å– gradle.properties ==="
        
        # è¯»å– mod_id å’Œç‰ˆæœ¬ä¿¡æ¯
        if [ -f "gradle.properties" ]; then
          MOD_ID=$(grep -E "^(mod_id|id|modname)=" gradle.properties | head -1 | cut -d'=' -f2- | tr -d '\r' | xargs)
          MOD_VERSION=$(grep -E "^(mod_version|version)=" gradle.properties | head -1 | cut -d'=' -f2- | tr -d '\r' | xargs)
        fi
        
        # è®¾ç½®é»˜è®¤å€¼
        if [ -z "$MOD_ID" ]; then
          MOD_ID="unknown-mod"
        fi
        if [ -z "$MOD_VERSION" ]; then
          MOD_VERSION="unknown"
        fi
        
        # æ¸…ç†å­—ç¬¦ä¸²
        MOD_ID=$(echo "$MOD_ID" | sed 's/^"//;s/"$//;s/^'\''//;s/'\''$//')
        MOD_VERSION=$(echo "$MOD_VERSION" | sed 's/^"//;s/"$//;s/^'\''//;s/'\''$//')
        
        echo "MOD_ID=$MOD_ID" >> $GITHUB_OUTPUT
        echo "MOD_VERSION=$MOD_VERSION" >> $GITHUB_OUTPUT
        echo "ARTIFACT_NAME=$MOD_ID-$MOD_VERSION" >> $GITHUB_OUTPUT
        echo "RELEASE_TITLE=$MOD_ID v$MOD_VERSION" >> $GITHUB_OUTPUT

    - name: Build with Gradle
      run: ./gradlew build

    - name: Prepare release assets
      run: |
        # æ‰¾åˆ°ä¸»è¦çš„JARæ–‡ä»¶
        MAIN_JAR=$(find build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -1)
        
        if [ -n "$MAIN_JAR" ]; then
          # å¤åˆ¶å¹¶é‡å‘½åä¸»æ–‡ä»¶
          cp "$MAIN_JAR" "${{ steps.mod-info.outputs.ARTIFACT_NAME }}.jar"
          echo "ä¸»æ–‡ä»¶: ${{ steps.mod-info.outputs.ARTIFACT_NAME }}.jar"
          
          # å¯é€‰ï¼šä¹Ÿå¤åˆ¶æºç å’Œæ–‡æ¡£åŒ…
          find build/libs -name "*-sources.jar" -exec cp {} . \;
          find build/libs -name "*-javadoc.jar" -exec cp {} . \;
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°JARæ–‡ä»¶"
          exit 1
        fi
        
        # åˆ—å‡ºæ‰€æœ‰è¦ä¸Šä¼ çš„æ–‡ä»¶
        echo "å°†è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼š"
        ls -la *.jar

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.mod-info.outputs.ARTIFACT_NAME }}.jar
          *.jar
        name: ${{ steps.mod-info.outputs.RELEASE_TITLE }}
        body: |
          # ${{ steps.mod-info.outputs.RELEASE_TITLE }}
          
          ğŸš€ è‡ªåŠ¨æ„å»ºçš„æ¨¡ç»„å‘å¸ƒ
          
          ## ç‰ˆæœ¬ä¿¡æ¯
          - **æ¨¡ç»„ID**: ${{ steps.mod-info.outputs.MOD_ID }}
          - **ç‰ˆæœ¬å·**: ${{ steps.mod-info.outputs.MOD_VERSION }}
          - **æ„å»ºæ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")
          - **GitHub Actionsè¿è¡ŒID**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ## ä¸‹è½½æ–‡ä»¶
          - `${{ steps.mod-info.outputs.ARTIFACT_NAME }}.jar` - ä¸»æ¨¡ç»„æ–‡ä»¶
          
          ## æ ¡éªŒå’Œ
          ```bash
          # SHA256 æ ¡éªŒå’Œ
          sha256sum ${{ steps.mod-info.outputs.ARTIFACT_NAME }}.jar
          ```
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true

    - name: Upload additional artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-build-${{ steps.mod-info.outputs.ARTIFACT_NAME }}
        path: |
          ${{ steps.mod-info.outputs.ARTIFACT_NAME }}.jar
          build/libs/*.jar
        retention-days: 30
